#!/usr/bin/env bash
#
# gt-mr-file - File a merge request bead for refinery to process
#
# Usage: gt-mr-file [--if-pushed]
#
# Options:
#   --if-pushed   Only file MR if branch has pushed commits ahead of target
#
# This script creates an MR bead with gt:merge-request label so refinery
# knows to process this branch.
#
# Part of Gas Town resilience-by-design: ensures polecat work reaches refinery.

set -euo pipefail

# Detect if we're in a polecat worktree
detect_context() {
    local cwd
    cwd=$(pwd)

    # Extract rig and polecat name from path
    # Pattern: .../lumicello_website/polecats/dementus/lumicello_website
    if [[ "$cwd" =~ /([^/]+)/polecats/([^/]+)/ ]]; then
        RIG="${BASH_REMATCH[1]}"
        POLECAT="${BASH_REMATCH[2]}"
        return 0
    fi

    return 1
}

# Get current branch name
get_branch() {
    git rev-parse --abbrev-ref HEAD 2>/dev/null
}

# Get target branch (main or preview)
get_target_branch() {
    # Check if preview branch exists
    if git rev-parse --verify origin/preview &>/dev/null; then
        echo "preview"
    else
        echo "main"
    fi
}

# Count commits ahead of target
commits_ahead() {
    local target="$1"
    git rev-list --count "origin/${target}..HEAD" 2>/dev/null || echo "0"
}

# Check if branch has been pushed
is_pushed() {
    local branch
    branch=$(get_branch)
    git rev-parse --verify "origin/${branch}" &>/dev/null
}

# Create MR bead
create_mr_bead() {
    local branch="$1"
    local target="$2"
    local commits="$3"

    local title="Merge: ${POLECAT}-$(echo "$branch" | sed 's/.*-//')"
    local description="Polecat ${POLECAT} branch ready for merge.

Branch: ${branch}
Target: ${target}
Commits: ${commits}
Rig: ${RIG}

Auto-filed by gt-mr-file on session end."

    # Create bead with merge-request label
    cd "$(git rev-parse --show-toplevel)"

    bd create \
        --title="$title" \
        --type=merge-request \
        --priority=2 \
        --label=gt:merge-request \
        --description="$description" 2>/dev/null || {
        echo "Warning: Could not create MR bead (bd may not be available)"
        return 1
    }

    echo "âœ… MR bead filed for branch: $branch"
}

main() {
    local if_pushed=false

    # Parse args
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --if-pushed)
                if_pushed=true
                shift
                ;;
            -h|--help)
                head -20 "$0" | tail -18
                exit 0
                ;;
            *)
                echo "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    # Must be in git repo
    if ! git rev-parse --git-dir &>/dev/null; then
        echo "Not in a git repository"
        exit 0
    fi

    # Detect polecat context
    if ! detect_context; then
        # Not in a polecat worktree, skip silently
        exit 0
    fi

    local branch target commits
    branch=$(get_branch)
    target=$(get_target_branch)
    commits=$(commits_ahead "$target")

    # If --if-pushed, check that branch is pushed
    if $if_pushed && ! is_pushed; then
        echo "Branch not pushed, skipping MR filing"
        exit 0
    fi

    # If no commits ahead, skip
    if [[ "$commits" -eq 0 ]]; then
        echo "No commits ahead of $target, skipping MR filing"
        exit 0
    fi

    # Check if MR bead already exists for this branch
    if bd list --label=gt:merge-request 2>/dev/null | grep -q "$branch"; then
        echo "MR bead already exists for $branch"
        exit 0
    fi

    # Create the MR bead
    create_mr_bead "$branch" "$target" "$commits"
}

main "$@"
