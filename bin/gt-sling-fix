#!/bin/bash
# gt-sling-fix: Workaround for gt sling hook issues
# Usage: gt-sling-fix <bead-id> <rig> [polecat-name]
#
# This script:
# 1. Creates polecat if needed (or uses existing)
# 2. Creates agent bead if missing
# 3. Hooks the bead with proper assignee
# 4. Sends mail with context

set -e

if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: gt-sling-fix <bead-id> <rig> [polecat-name]"
    echo "Example: gt-sling-fix ds-ctz 10x_screening"
    echo "Example: gt-sling-fix ds-ctz 10x_screening furiosa"
    exit 1
fi

BEAD_ID="$1"
RIG="$2"
POLECAT_NAME="${3:-furiosa}"  # Default to furiosa
GT_ROOT="/Users/tanwa/gt"

POLECAT_DIR="$GT_ROOT/$RIG/polecats/$POLECAT_NAME"
AGENT_ID="$RIG/polecats/$POLECAT_NAME"

echo "ðŸŽ¯ Slinging $BEAD_ID to $AGENT_ID"
echo ""

# Check if polecat exists
if [ ! -d "$POLECAT_DIR" ]; then
    echo "Creating polecat $POLECAT_NAME..."
    gt polecat add "$RIG" "$POLECAT_NAME" 2>/dev/null || true
fi

# Verify polecat directory exists (handle both flat and nested structures)
# New gt polecat add creates: polecats/NAME/RIG_NAME/
# Old structure: polecats/NAME/
if [ ! -d "$POLECAT_DIR" ]; then
    echo "ERROR: Failed to create polecat directory: $POLECAT_DIR"
    exit 1
fi

# Check for nested worktree structure and use that as working directory
if [ -d "$POLECAT_DIR/$RIG" ]; then
    WORK_DIR="$POLECAT_DIR/$RIG"
    echo "Using nested worktree: $WORK_DIR"
else
    WORK_DIR="$POLECAT_DIR"
fi

# Ensure beads redirect exists in polecat root (not the nested worktree)
if [ ! -f "$POLECAT_DIR/.beads/redirect" ]; then
    mkdir -p "$POLECAT_DIR/.beads"
    echo "../../mayor/rig/.beads" > "$POLECAT_DIR/.beads/redirect"
    echo "Created beads redirect"
fi

# Get bead prefix for agent bead naming
BEAD_PREFIX=$(echo "$BEAD_ID" | cut -d'-' -f1)

# Create agent bead if missing
AGENT_BEAD_ID="${BEAD_PREFIX}-${RIG}-polecat-${POLECAT_NAME}"
if ! bd show "$AGENT_BEAD_ID" &>/dev/null; then
    echo "Creating agent bead: $AGENT_BEAD_ID"
    bd create --id="$AGENT_BEAD_ID" --type=agent \
        --title="Polecat $POLECAT_NAME for $RIG" \
        --description="$AGENT_BEAD_ID

role_type: polecat
rig: $RIG
agent_state: idle
hook_bead:
role_bead: gt-polecat-role" --force 2>/dev/null || true
fi

# Unhook any existing beads assigned to this polecat
cd "$WORK_DIR"
echo "Checking for existing hooked beads..."
EXISTING_HOOKED=$(bd list --status=hooked --assignee="$AGENT_ID" --json 2>/dev/null | jq -r '.[].id' 2>/dev/null || true)
for OLD_BEAD in $EXISTING_HOOKED; do
    if [ -n "$OLD_BEAD" ] && [ "$OLD_BEAD" != "$BEAD_ID" ]; then
        echo "Unhooking previous bead: $OLD_BEAD"
        bd update "$OLD_BEAD" --status=open 2>/dev/null || true
    fi
done

# Hook the bead - CRITICAL: Write .gt-hook file directly
# The gt hook command may not create this file reliably
echo "Hooking $BEAD_ID..."
echo "$BEAD_ID" > "$POLECAT_DIR/.gt-hook"
gt hook "$BEAD_ID" 2>/dev/null || true

# Fix: Set assignee and status
bd update "$BEAD_ID" --assignee="$AGENT_ID" --status=hooked

# Update agent bead with hook info
bd update "$AGENT_BEAD_ID" --description="$AGENT_BEAD_ID

role_type: polecat
rig: $RIG
agent_state: working
hook_bead: $BEAD_ID
role_bead: gt-polecat-role" 2>/dev/null || true

echo ""
echo "âœ“ Slung: $BEAD_ID â†’ $AGENT_ID"

# Auto-spawn tmux session with Claude
SESSION_NAME="gt-${RIG}-${POLECAT_NAME}"
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "âš ï¸  Session already running: $SESSION_NAME"
    echo "   Existing sessions have stale context - restarting..."
    tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true
    sleep 1
fi

echo "ðŸš€ Spawning polecat session with GUPP auto-execute..."
# GUPP FIX: Pipe gt-prime-safe to Claude (avoids identity bug from gt prime)
# gt-prime-safe detects identity from CWD, not ~/gt, and triggers GUPP if work is hooked
tmux new-session -d -s "$SESSION_NAME" "cd $WORK_DIR && ~/gt/bin/gt-prime-safe | claude --dangerously-skip-permissions"
echo "âœ“ Spawned: $SESSION_NAME"
echo "âœ… Polecat auto-executing via piped input (GUPP fix)"

echo ""
echo "To attach:"
echo "  tmux attach -t $SESSION_NAME"
