#!/bin/bash
# gt-town-start: Complete Gas Town startup (gt up + workarounds)
#
# This wraps 'gt up' and starts additional workaround services that
# aren't part of official Gas Town but are needed for stable operation.
#
# Usage:
#   ~/gt/bin/gt-town-start
#
# To make this run at login:
#   echo '~/gt/bin/gt-town-start' >> ~/.zshrc

set -e

echo "üèôÔ∏è  Starting Gas Town..."
echo ""

# Start core Gas Town services
echo "1Ô∏è‚É£  Starting core services (gt start)..."
gt start

echo ""

# Start workarounds/hacks
echo "2Ô∏è‚É£  Starting workaround services..."

# HACK: Auto-enter for stuck agent prompts
# See bead gm-2ehf for why this is needed and when to remove
if [ -f ~/gt/bin/gt-auto-enter ]; then
    if ~/gt/bin/gt-auto-enter status >/dev/null 2>&1; then
        echo "   ‚úÖ gt-auto-enter already running"
    else
        ~/gt/bin/gt-auto-enter start
        echo "   ‚úÖ gt-auto-enter started (workaround for stuck prompts)"
    fi
else
    echo "   ‚ö†Ô∏è  gt-auto-enter not found - agents may get stuck at prompts"
fi

# Witness patrol scheduler - ensures witnesses run patrols periodically
# Part of resilience-by-design: automated orphan detection
if [ -f ~/gt/bin/gt-witness-scheduler ]; then
    if ~/gt/bin/gt-witness-scheduler status 2>/dev/null | grep -q "running"; then
        echo "   ‚úÖ gt-witness-scheduler already running"
    else
        ~/gt/bin/gt-witness-scheduler start
        echo "   ‚úÖ gt-witness-scheduler started (10 min patrol interval)"
    fi
else
    echo "   ‚ö†Ô∏è  gt-witness-scheduler not found - witness patrols won't auto-run"
fi

echo ""
echo "‚úÖ Gas Town fully started"
echo ""
echo "Services:"
echo "  ‚Ä¢ Core: gt status"
echo "  ‚Ä¢ Auto-enter: ~/gt/bin/gt-auto-enter status"
echo "  ‚Ä¢ Witness scheduler: ~/gt/bin/gt-witness-scheduler status"
echo ""
echo "To stop everything:"
echo "  gt shutdown && ~/gt/bin/gt-auto-enter stop && ~/gt/bin/gt-witness-scheduler stop"
