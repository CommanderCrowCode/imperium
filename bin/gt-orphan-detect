#!/usr/bin/env bash
#
# gt-orphan-detect - Detect orphaned polecat branches with unmerged work
#
# Usage: gt-orphan-detect [rig-name]
#
# An orphan branch is a polecat branch that:
# 1. Has commits ahead of main/preview
# 2. No active polecat session working on it
# 3. No MR bead filed for it
#
# Part of Gas Town resilience-by-design: detects work that might be lost.

set -euo pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

get_rig_from_cwd() {
    local cwd
    cwd=$(pwd)

    # Extract rig name from path patterns like:
    # /Users/tanwa/gt/<rig>/witness
    # /Users/tanwa/gt/<rig>/polecats/<name>
    if [[ "$cwd" =~ /gt/([^/]+)/(witness|polecats|refinery|crew) ]]; then
        echo "${BASH_REMATCH[1]}"
        return 0
    fi

    return 1
}

get_target_branch() {
    local repo_path="$1"
    cd "$repo_path"
    if git rev-parse --verify origin/preview &>/dev/null; then
        echo "preview"
    else
        echo "main"
    fi
}

count_commits_ahead() {
    local branch="$1"
    local target="$2"
    git rev-list --count "origin/${target}..origin/${branch}" 2>/dev/null || echo "0"
}

is_session_active() {
    local rig="$1"
    local polecat="$2"
    local session_name="gt-${rig}-${polecat}"

    tmux has-session -t "$session_name" 2>/dev/null
}

has_mr_bead() {
    local branch="$1"
    local rig_path="$2"

    cd "$rig_path"
    bd list --label=gt:merge-request 2>/dev/null | grep -q "$branch"
}

main() {
    local rig="${1:-}"

    # Get rig name from arg or cwd
    if [[ -z "$rig" ]]; then
        rig=$(get_rig_from_cwd) || {
            echo "Usage: gt-orphan-detect <rig-name>"
            echo "Or run from within a rig directory"
            exit 1
        }
    fi

    local rig_path="$HOME/gt/$rig"
    local polecats_path="$rig_path/polecats"

    if [[ ! -d "$polecats_path" ]]; then
        echo "No polecats directory for rig: $rig"
        exit 0
    fi

    # Find any git worktree to use for branch listing
    local repo_path
    repo_path=$(find "$polecats_path" -maxdepth 2 -name ".git" -type f 2>/dev/null | head -1 | xargs dirname 2>/dev/null) || true

    if [[ -z "$repo_path" ]]; then
        # Fallback to mayor/rig
        repo_path="$rig_path/mayor/rig"
        if [[ ! -d "$repo_path/.git" ]]; then
            echo "No git repository found for $rig"
            exit 0
        fi
    fi

    cd "$repo_path"
    git fetch --quiet origin 2>/dev/null || true

    local target
    target=$(get_target_branch "$repo_path")

    echo "üîç Scanning for orphan branches in $rig (target: $target)"
    echo ""

    local orphans_found=0
    local polecat_branches
    polecat_branches=$(git branch -r 2>/dev/null | grep "origin/polecat/" | sed 's/origin\///' | tr -d ' ')

    if [[ -z "$polecat_branches" ]]; then
        echo -e "${GREEN}‚úÖ No polecat branches found${NC}"
        exit 0
    fi

    while IFS= read -r branch; do
        [[ -z "$branch" ]] && continue

        local commits_ahead
        commits_ahead=$(count_commits_ahead "$branch" "$target")

        # Skip if no commits ahead
        [[ "$commits_ahead" -eq 0 ]] && continue

        # Extract polecat name from branch (e.g., polecat/dementus-mkdi3jor -> dementus)
        local polecat_name
        polecat_name=$(echo "$branch" | sed 's|polecat/||' | cut -d'-' -f1)

        # Check if session is active
        local session_status="inactive"
        if is_session_active "$rig" "$polecat_name"; then
            session_status="active"
        fi

        # Check if MR bead exists
        local mr_status="no MR bead"
        if has_mr_bead "$branch" "$rig_path"; then
            mr_status="MR filed"
        fi

        # Only report as orphan if no active session AND no MR bead
        if [[ "$session_status" == "inactive" && "$mr_status" == "no MR bead" ]]; then
            ((orphans_found++))
            echo -e "${YELLOW}‚ö†Ô∏è  ORPHAN: ${branch}${NC}"
            echo "   Commits ahead: $commits_ahead"
            echo "   Session: $session_status"
            echo "   MR bead: $mr_status"
            echo ""
        fi
    done <<< "$polecat_branches"

    echo "=================================="
    if [[ "$orphans_found" -gt 0 ]]; then
        echo -e "${RED}Found $orphans_found orphaned branch(es)!${NC}"
        echo ""
        echo "To fix orphan branches:"
        echo "  1. Manually merge: git merge origin/<branch>"
        echo "  2. Or file MR bead: bd create --title='Merge: <branch>' --type=merge-request --label=gt:merge-request"
        echo "  3. Or delete if abandoned: git push origin --delete <branch>"
        exit 1
    else
        echo -e "${GREEN}‚úÖ No orphan branches found${NC}"
        exit 0
    fi
}

main "$@"
