#!/usr/bin/env python3
"""Archive old mail for dormant crew members.

Preserves high-priority messages (P0/P1) and only archives low-priority
messages older than the specified cutoff.
"""

import subprocess
import sys
from datetime import datetime, timedelta
import re


def run_cmd(cmd):
    """Run command and return output."""
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        return result.stdout
    except Exception:
        return ""


def get_crew_agents(town_root="/Users/tanwa/gt"):
    """Find all crew agents."""
    agents = []
    cmd = f"find {town_root}/*/crew/* -maxdepth 0 -type d 2>/dev/null"
    output = run_cmd(cmd)

    for path in output.strip().split('\n'):
        if path:
            parts = path.split('/')
            rig = parts[-3]
            crew_name = parts[-1]
            agents.append(f"{rig}/crew/{crew_name}")

    return agents


def get_inbox_messages(agent_addr):
    """Get unread message IDs for an agent."""
    cmd = f"gt mail inbox '{agent_addr}' 2>/dev/null"
    output = run_cmd(cmd)

    # Extract message IDs (gm-XXXXX pattern)
    message_ids = re.findall(r'gm-[a-z0-9]+', output)
    return message_ids


def get_message_details(msg_id):
    """Get message date, subject, and priority."""
    cmd = f"gt mail read '{msg_id}' 2>/dev/null"
    output = run_cmd(cmd)

    date = None
    subject = ""
    priority = None

    for line in output.split('\n'):
        if line.startswith('Date:'):
            date_str = line.split('Date:')[1].strip()
            try:
                # Parse date (format: 2026-01-27 14:55:41)
                date = datetime.strptime(date_str[:10], '%Y-%m-%d')
            except:
                pass
        elif line.startswith('Subject:'):
            subject = line.split('Subject:')[1].strip()
            # Check for priority markers in subject
            if 'â— P0' in subject or '[P0]' in subject:
                priority = 0
            elif 'â— P1' in subject or '[P1]' in subject:
                priority = 1

    return date, subject, priority


def archive_message(msg_id, agent_addr, town_root="/Users/tanwa/gt"):
    """Archive a message."""
    # Parse agent address to get directory path
    parts = agent_addr.split('/')
    rig = parts[0]
    crew_dir = '/'.join(parts[1:])  # crew/name

    crew_path = f"{town_root}/{rig}/{crew_dir}"
    cmd = f"cd '{crew_path}' && gt mail archive '{msg_id}' 2>/dev/null"
    result = subprocess.run(cmd, shell=True, capture_output=True)
    return result.returncode == 0


def main():
    days = int(sys.argv[1]) if len(sys.argv) > 1 else 7
    dry_run = '--dry-run' in sys.argv

    cutoff_date = datetime.now() - timedelta(days=days)

    print(f"ğŸ“¦ Archiving crew mail older than {days} days (before {cutoff_date.strftime('%Y-%m-%d')})")
    print("   Preserving P0/P1 priority messages")
    if dry_run:
        print("   [DRY RUN MODE]")
    print()

    archived_count = 0
    preserved_count = 0
    skipped_count = 0

    agents = get_crew_agents()

    for agent_addr in agents:
        message_ids = get_inbox_messages(agent_addr)

        if len(message_ids) > 5:
            print(f"  ğŸ“¬ {agent_addr}: {len(message_ids)} messages")

            for msg_id in message_ids:
                msg_date, subject, priority = get_message_details(msg_id)

                if msg_date and msg_date < cutoff_date:
                    # Preserve high-priority messages
                    if priority is not None and priority <= 1:
                        print(f"    âš¡ Preserved (P{priority}): {msg_id} - {subject[:60]}")
                        preserved_count += 1
                        continue

                    if dry_run:
                        print(f"    [DRY RUN] Would archive: {msg_id} - {subject[:60]} ({msg_date.strftime('%Y-%m-%d')})")
                        archived_count += 1
                    else:
                        if archive_message(msg_id, agent_addr):
                            print(f"    âœ“ Archived: {msg_id} - {subject[:60]}")
                            archived_count += 1
                        else:
                            print(f"    âœ— Failed: {msg_id}")
                            skipped_count += 1

    print()
    print(f"Done. {'Would archive' if dry_run else 'Archived'}: {archived_count}, Preserved: {preserved_count}, Failed: {skipped_count}")

    # Send summary to overseer if real run
    if not dry_run and archived_count > 0:
        summary = f"Archived {archived_count} old crew messages (>{days} days), preserved {preserved_count} high-priority messages."
        subprocess.run(
            f"gt mail send overseer -s 'ğŸ“¦ Crew mail archived' -m '{summary}'",
            shell=True,
            capture_output=True
        )


if __name__ == '__main__':
    main()
